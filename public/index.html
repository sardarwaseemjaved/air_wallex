<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Airwallex Checkout Demo</title>
</head>
<body>
  <h1>Airwallex Hosted Checkout Demo</h1>

  <!-- New Customer Flow -->
  <h2>Create New Customer</h2>
  <input type="text" id="merchantCustomerId" placeholder="Merchant Customer ID" />
  <button id="createCustomerBtn">Create Customer & Pay</button>
  <p id="customerResult"></p>

  <!-- Existing Customer Flow -->
  <h2>Use Existing Customer</h2>
  <input type="text" id="existingCustomerId" placeholder="Existing Customer ID" />
  <button id="existingCustomerBtn">Pay with Existing Customer</button>
  <p id="existingResult"></p>

  <script>
    const backendBaseUrl = "https://air-wallex.vercel.app"; // your deployed backend

    async function createCustomerFlow() {
      const merchantCustomerId = document.getElementById("merchantCustomerId").value;
      if (!merchantCustomerId) return alert("Enter Merchant Customer ID");

      try {
        // Step 1: Create customer + get client_secret
        const createResp = await fetch(`${backendBaseUrl}/api/create-customer`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ merchant_customer_id: merchantCustomerId })
        });
        const { customer, client_secret, error } = await createResp.json();
        if (error || !customer?.id) {
          return alert("Failed to create customer: " + JSON.stringify(error));
        }
        document.getElementById("customerResult").innerText = "Customer created: " + customer.id;

        // Step 2: Create payment intent
        const piResp = await fetch(`${backendBaseUrl}/api/create-payment-intent`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            amount: 100, // $1.00
            currency: "USD",
            customer_id: customer.id
          })
        });
        const { intent_id, client_secret: piSecret, error: piError } = await piResp.json();
        if (piError || !intent_id) {
          return alert("Failed to create payment intent: " + JSON.stringify(piError));
        }

        // Step 3: Redirect user to Hosted Payment Page
        window.location.href = `https://checkout-demo.airwallex.com/#/payment/intent?client_secret=${piSecret}`;
      } catch (err) {
        console.error("New customer flow error:", err);
        alert("Error in new customer flow");
      }
    }

    async function existingCustomerFlow() {
      const customerId = document.getElementById("existingCustomerId").value;
      if (!customerId) return alert("Enter Customer ID");

      try {
        // Step 1: Create payment intent
        const piResp = await fetch(`${backendBaseUrl}/api/create-payment-intent`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            amount: 100,
            currency: "USD",
            customer_id: customerId
          })
        });
        const { intent_id, client_secret, error } = await piResp.json();
        if (error || !intent_id) {
          return alert("Failed to create payment intent: " + JSON.stringify(error));
        }

        // Step 2: Redirect user to Hosted Payment Page
        window.location.href = `https://checkout-demo.airwallex.com/#/payment/intent?client_secret=${client_secret}`;
      } catch (err) {
        console.error("Existing customer flow error:", err);
        alert("Error in existing customer flow");
      }
    }

    document.getElementById("createCustomerBtn").addEventListener("click", createCustomerFlow);
    document.getElementById("existingCustomerBtn").addEventListener("click", existingCustomerFlow);
  </script>
</body>
</html>
